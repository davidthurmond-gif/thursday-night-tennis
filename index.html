<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berwick Tennis Club — Thursday Night Comp (Autumn 2026)</title>
  <style>
    :root{
      --navy:#0b1e3a;
      --bg:#070b16;
      --card:rgba(18,26,51,.78);
      --muted:#93a4c7;
      --text:#e9eeff;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(125,211,252,.20), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(167,139,250,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{position:sticky; top:0; backdrop-filter: blur(10px); background: rgba(7,11,22,.78); border-bottom:1px solid var(--border); z-index:10}
    .wrap{max-width:1150px; margin:0 auto; padding:18px 18px}
    .top{display:flex; align-items:center; gap:14px; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px}
    h1{font-size:18px; margin:0}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}

    nav{display:flex; gap:8px; flex-wrap:wrap}
    .tab{border:1px solid var(--border); background: rgba(18,26,51,.65); color:var(--text);
      padding:10px 12px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .tab[aria-selected="true"]{border-color: rgba(125,211,252,.55); background: rgba(125,211,252,.12)}

    main{padding:18px 0 60px}
    .grid{display:grid; gap:14px}
    .grid.two{grid-template-columns: 1.15fr .85fr}
    @media (max-width: 900px){.grid.two{grid-template-columns:1fr}}

    .card{background: var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow)}
    .card .hd{padding:14px 14px 0}
    .card .bd{padding:14px}
    .title{font-size:16px; margin:0 0 6px}
    .muted{color:var(--muted)}

    .pill{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:13px; vertical-align:top}
    th{font-size:12px; color:var(--muted); font-weight:600}
    tr:hover td{background: rgba(255,255,255,.03)}
    .right{text-align:right}
    .center{text-align:center}

    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 760px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .k{padding:12px; border:1px solid var(--border); border-radius:14px; background: rgba(255,255,255,.03)}
    .k .n{font-size:20px; font-weight:800}
    .k .l{font-size:12px; color:var(--muted)}

    .btn{border:1px solid var(--border); background: rgba(255,255,255,.04); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-size:13px}
    .btn.primary{border-color: rgba(125,211,252,.55); background: rgba(125,211,252,.14)}
    .btn.danger{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.10)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,input{background: rgba(7,11,22,.65); border:1px solid var(--border); color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:13px; outline:none
    }
    input[type="number"]{width:86px}
    .hint{font-size:12px; color:var(--muted)}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}
    .badge.good{border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95)}
    .badge.warn{border-color: rgba(251,191,36,.45); color: rgba(251,191,36,.95)}
    .badge.bad{border-color: rgba(251,113,133,.45); color: rgba(251,113,133,.95)}
    .foot{margin-top:10px; font-size:12px; color:var(--muted)}

    /* Club crest logo (navy/white) */
    .crestWrap{
      width:46px; height:46px; border-radius:14px;
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      background: rgba(18,26,51,.65);
      border:1px solid var(--border);
    }
    .crestWrap svg{display:block}

    /* Team chip popover (tap/hover) */
    .team-chip{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      line-height: 1.2;
      user-select:none;
    }
    .team-chip:hover{border-color: rgba(125,211,252,.45)}
    .team-pop{
      position:absolute;
      top: calc(100% + 8px);
      left: 0;
      min-width: 260px;
      background: rgba(18,26,51,.98);
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding:10px 10px;
      display:none;
      z-index: 50;
    }
    .team-chip:hover .team-pop{display:block}
    .team-chip[data-open="true"] .team-pop{display:block}
    .team-pop .hdr{
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom:8px; margin-bottom:8px; border-bottom:1px solid var(--border);
    }
    .team-pop .hdr b{font-size:13px}
    .team-pop .closex{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding:4px 8px;
      cursor:pointer;
      font-size:12px;
      display:none;
    }
    .team-pop .p{
      display:flex; justify-content:space-between; gap:10px;
      padding:5px 4px;
      border-radius: 10px;
    }
    .team-pop .p:hover{background: rgba(255,255,255,.03)}
    .team-pop .rank{color: var(--muted); font-size:12px}
    .team-pop .name{font-size:13px}

    @media (max-width: 760px){
      .team-chip:hover .team-pop{display:none}
      .team-pop{position:fixed; left:50%; transform:translateX(-50%); top:16%; width:min(560px, 94vw)}
      .team-pop .closex{display:inline-flex}
      input[type="number"]{width:78px}
    }

    /* Scoresheet-style entry grid */
    .sheet{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .sheet .head{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .sheet .meta{display:flex; flex-direction:column; gap:4px}
    .sheet .meta .line{font-size:12px; color:var(--muted)}
    .sheet .teams{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:100%;
      margin-top:8px;
    }
    @media (max-width:760px){ .sheet .teams{grid-template-columns:1fr} }

    .teamBox{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }
    .teamBox .tname{font-weight:800}
    .teamBox .plist{margin-top:8px; display:grid; gap:6px}
    .teamBox .prow{display:flex; justify-content:space-between; gap:10px}
    .teamBox .prow .r{color:var(--muted); font-size:12px}

    .gridRow{
      display:grid;
      grid-template-columns: 110px 1fr 1fr 90px;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      align-items:center;
    }
    .gridRow:last-child{border-bottom:none}
    .pairTag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:999px;
      width:max-content;
      background: rgba(255,255,255,.02);
    }
    .cell{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .cell .who{font-size:12px; color:var(--muted)}
    .winMark{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .winMark.good{border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95)}
    .winMark.bad{border-color: rgba(251,113,133,.45); color: rgba(251,113,133,.95)}
    .winMark.warn{border-color: rgba(251,191,36,.45); color: rgba(251,191,36,.95)}

    @media (max-width:760px){
      .gridRow{grid-template-columns: 1fr; gap:8px}
      .gridRow .rightish{justify-content:flex-start}
    }

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:760px){ .totals{grid-template-columns:1fr} }
    .tot{border:1px solid var(--border); border-radius:14px; padding:10px; background: rgba(255,255,255,.02)}
    .tot .k{font-size:12px; color:var(--muted)}
    .tot .v{font-size:18px; font-weight:900; margin-top:4px}

    dialog{border:none; border-radius:18px; padding:0; background: rgba(18,26,51,.98); color:var(--text); width:min(520px, 92vw); box-shadow: var(--shadow)}
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .modal-hd{padding:14px 14px 0}
    .modal-bd{padding:14px}
    .modal-ft{padding:0 14px 14px; display:flex; justify-content:flex-end; gap:10px}

    @media print{
      header{position:static; background:#fff; color:#000; border:none}
      body{background:#fff; color:#000}
      .card{box-shadow:none; background:#fff; border:1px solid #ccc}
      .tab, .btn, .pill{display:none}
      a{color:#000}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap top">
      <div class="brand">
        <div class="crestWrap" aria-hidden="true" title="Berwick Tennis Club • Est. 1948">
          <svg viewBox="0 0 200 200" width="38" height="38" aria-hidden="true">
            <circle cx="100" cy="100" r="92" fill="none" stroke="#ffffff" stroke-width="6"/>
            <circle cx="100" cy="100" r="78" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="2"/>
            <path d="M70 135 L135 70" stroke="#ffffff" stroke-width="7" stroke-linecap="round"/>
            <path d="M70 70 L135 135" stroke="#ffffff" stroke-width="7" stroke-linecap="round"/>
            <circle cx="100" cy="100" r="14" fill="#ffffff"/>
            <text x="100" y="38" text-anchor="middle" fill="#ffffff" font-size="20" font-weight="800">TENNIS</text>
            <text x="100" y="168" text-anchor="middle" fill="#ffffff" font-size="16" font-weight="700">EST. 1948</text>
          </svg>
        </div>
        <div>
          <h1>Berwick Tennis Club — Thursday Night Comp</h1>
          <div class="sub">Autumn 2026 • 7 teams • 14 rounds • Navy & White</div>
        </div>
      </div>
      <nav aria-label="Sections">
        <button class="tab" data-view="home" aria-selected="true">Home</button>
        <button class="tab" data-view="teams">Teams</button>
        <button class="tab" data-view="fixtures">Fixtures</button>
        <button class="tab" data-view="results">Upload Scores</button>
        <button class="tab" data-view="ladder">Ladder</button>
        <button class="tab" data-view="players">Player Stats</button>
        <button class="tab" data-view="rules">Rules</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="view">
      <div class="grid two">
        <div class="card">
          <div class="hd">
            <div class="row" style="justify-content:space-between">
              <h2 class="title">Next Round</h2>
              <span class="pill"><span class="dot"></span><span id="nextRoundPill">Loading…</span></span>
            </div>
            <div class="muted" id="nextRoundDate" style="margin-top:4px"></div>
          </div>
          <div class="bd">
            <div id="nextRoundMatches"></div>
            <div class="foot">Tip: This version saves results in your browser (localStorage). Once you’re happy, we can connect it to a shared Google Sheet so everyone sees the same ladder.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2 class="title">Quick Stats</h2><div class="muted">Updates instantly as you upload scores</div></div>
          <div class="bd">
            <div class="kpi">
              <div class="k"><div class="n" id="kpiRoundsDone">0</div><div class="l">Rounds completed</div></div>
              <div class="k"><div class="n" id="kpiMatchesDone">0</div><div class="l">Matches recorded</div></div>
              <div class="k"><div class="n" id="kpiTopTeam">—</div><div class="l">Current leader</div></div>
              <div class="k"><div class="n" id="kpiTopPlayer">—</div><div class="l">Top player (sets won)</div></div>
            </div>
            <div style="margin-top:12px" class="row">
              <button class="btn primary" id="btnPrint">Print</button>
              <button class="btn" id="btnExport">Export results</button>
              <label class="btn" for="importFile" style="cursor:pointer">Import results</label>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="hd"><h2 class="title">Latest Results</h2><div class="muted">Most recent uploaded matches</div></div>
        <div class="bd" id="latestResults"></div>
      </div>
    </section>

    <!-- TEAMS -->
    <section id="view-teams" class="view" hidden>
      <div class="card">
        <div class="hd"><h2 class="title">Teams & Players</h2><div class="muted">Player 1 is the strongest, Player 4 is the developing player</div></div>
        <div class="bd" id="teamsGrid"></div>
      </div>
    </section>

    <!-- FIXTURES -->
    <section id="view-fixtures" class="view" hidden>
      <div class="card">
        <div class="hd">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 class="title">Fixtures</h2>
              <div class="muted">Rounds 1–14</div>
            </div>
            <div class="row">
              <span class="hint">Jump to round:</span>
              <select id="roundJump"></select>
              <button class="btn" id="btnGo">Go</button>
            </div>
          </div>
        </div>
        <div class="bd" id="fixturesList"></div>
      </div>
    </section>

    <!-- UPLOAD SCORES -->
    <section id="view-results" class="view" hidden>
      <div class="card">
        <div class="hd">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 class="title">Upload Scores</h2>
              <div class="muted">Matches follow the paper sheet: enter games (first to 6) for each doubles pairing</div>
            </div>
            <div class="row">
              <button class="btn" id="btnClearMatch" title="Clear this match (local only)">Clear match</button>
              <button class="btn danger" id="btnResetAll">Reset all results</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:12px">
            <span class="hint">Round:</span>
            <select id="roundSelect"></select>
            <span class="hint">Match:</span>
            <select id="matchSelect"></select>
            <button class="btn primary" id="btnLoadSheet">Load score sheet</button>
          </div>

          <div id="sheetHost"></div>

          <div class="foot">Validation: each set should be a 6–x score. If you enter something else (e.g. 6–6 or 5–4) we’ll flag it.</div>
        </div>
      </div>
    </section>

    <!-- LADDER -->
    <section id="view-ladder" class="view" hidden>
      <div class="card">
        <div class="hd"><h2 class="title">Ladder</h2><div class="muted">Tie-breakers: Points → Set Differential → Sets Won → Team #</div></div>
        <div class="bd">
          <div id="ladderTable"></div>
          <div class="foot">Points per match: 1 point per set won + 2 bonus points if you win the night (no bonus on a 3–3 tie).</div>
        </div>
      </div>
    </section>

    <!-- PLAYER STATS -->
    <section id="view-players" class="view" hidden>
      <div class="card">
        <div class="hd"><h2 class="title">Player Statistics</h2><div class="muted">Calculated from the 6 doubles pairings each night</div></div>
        <div class="bd">
          <div id="playerStatsTable"></div>
          <div class="foot">Leaderboard sorts by Win % (min 6 sets), then Sets Won, then Sets Played.</div>
        </div>
      </div>
    </section>

    <!-- RULES -->
    <section id="view-rules" class="view" hidden>
      <div class="card">
        <div class="hd"><h2 class="title">Rules</h2><div class="muted">As used in the Berwick Thursday Night Comp</div></div>
        <div class="bd">
          <ul style="margin:0; padding-left:18px; line-height:1.55">
            <li>Each Thursday: <b>Team of 4</b> plays another <b>Team of 4</b>.</li>
            <li>There are <b>6 doubles sets</b>:</li>
            <ul>
              <li><b>1+2</b> vs <b>1+2</b></li>
              <li><b>3+4</b> vs <b>3+4</b></li>
              <li><b>1+3</b> vs <b>1+3</b></li>
              <li><b>2+4</b> vs <b>2+4</b></li>
              <li><b>1+4</b> vs <b>1+4</b></li>
              <li><b>2+3</b> vs <b>2+3</b></li>
            </ul>
            <li>First team to <b>6 games</b> wins the set.</li>
            <li>Night points:</li>
            <ul>
              <li><b>1 point per set won</b> (0–6 points)</li>
              <li><b>+2 bonus points</b> if you win more sets overall</li>
              <li><b>No bonus</b> if it’s a 3–3 tie</li>
            </ul>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <dialog id="confirmDialog">
    <div class="modal-hd">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 class="title" style="margin-top:8px" id="confirmTitle">Confirm</h3>
          <div class="muted" id="confirmMsg"></div>
        </div>
        <button class="btn" id="btnConfirmClose">Close</button>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn" id="btnConfirmNo">Cancel</button>
      <button class="btn danger" id="btnConfirmYes">Yes</button>
    </div>
  </dialog>

<script>
/* =========================
   DATA (Teams + Fixtures)
   ========================= */

const SEASON_KEY = "btc_thursday_autumn_2026_v1";

const teams = {
  1:{ name:"Team 1", players:["Cooper Khalil","Simran Chawla","David Sutton","Chris Maniatakis"] },
  2:{ name:"Team 2", players:["Enrique Lopez","Craig Kitner","Josh Bury","Varun Sridhara"] },
  3:{ name:"Team 3", players:["Michael Rominger","David Ng","Cameron Rush","Alan Chumacero"] },
  4:{ name:"Team 4", players:["Jonathan Rogers","Rafa Bouzinelos","David Thurmond","Andrew Watson"] },
  5:{ name:"Team 5", players:["Chung Tan","Huss Shafai","Tom Maloney","Brett Kurz"] },
  6:{ name:"Team 6", players:["Vignesh Pakkiam","Eric Castricum","Stephen Saunders","Mark Findlay"] },
  7:{ name:"Team 7", players:["Chris Scott","Justin Hermann","Nick Teo","Dishit Devasia"] },
};

// Fixtures (matches per round; null means Bye)
const rounds = [
  { r:1,  date:"05-Feb-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:2,  date:"12-Feb-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:3,  date:"19-Feb-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:4,  date:"26-Feb-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:5,  date:"05-Mar-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:6,  date:"12-Mar-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:7,  date:"19-Mar-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
  { r:8,  date:"26-Mar-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:9,  date:"23-Apr-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:10, date:"30-Apr-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:11, date:"07-May-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:12, date:"14-May-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:13, date:"21-May-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:14, date:"28-May-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
];

// Pairing order EXACTLY like your sheet
const pairings = [
  { key:"12", label:"1 + 2", a:[1,2], b:[1,2] },
  { key:"34", label:"3 + 4", a:[3,4], b:[3,4] },
  { key:"13", label:"1 + 3", a:[1,3], b:[1,3] },
  { key:"24", label:"2 + 4", a:[2,4], b:[2,4] },
  { key:"14", label:"1 + 4", a:[1,4], b:[1,4] },
  { key:"23", label:"2 + 3", a:[2,3], b:[2,3] },
];

/* =========================
   STORAGE
   =========================
   RESULTS shape:
   {
     "r1_m0": {
       a: 1, b: 6,
       pairs: { "12":{a:6,b:2}, "34":{a:6,b:0}, ... },
       aSets: 5, bSets: 1,
       aGamesTotal: 30, bGamesTotal: 17,
       aPts: 7, bPts: 1,
       ts: 170...
     },
     ...
   }
*/
let RESULTS = loadResults_();

function loadResults_(){
  try{
    const raw = localStorage.getItem(SEASON_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){
    return {};
  }
}
function saveResults_(){
  localStorage.setItem(SEASON_KEY, JSON.stringify(RESULTS));
}

/* =========================
   SCORING
   ========================= */

function calcNightPoints(aSets, bSets){
  let aPts = Number(aSets)||0;
  let bPts = Number(bSets)||0;
  if (aSets > bSets) aPts += 2;
  else if (bSets > aSets) bPts += 2;
  return {aPts, bPts};
}

function decideSetWinner(aGames, bGames){
  // normal expected: one side == 6 and other < 6
  aGames = Number(aGames);
  bGames = Number(bGames);
  if (!Number.isFinite(aGames) || !Number.isFinite(bGames)) return {winner: null, status:"empty"};
  if (aGames === 6 && bGames !== 6) return {winner:"A", status:"ok"};
  if (bGames === 6 && aGames !== 6) return {winner:"B", status:"ok"};
  // allow 7-6 etc? not specified, so treat as warn but still pick higher if one >=6 and different
  if ((aGames >= 6 || bGames >= 6) && aGames !== bGames){
    return {winner: (aGames > bGames ? "A":"B"), status:"warn"};
  }
  return {winner: null, status:"warn"};
}

function matchId(roundNum, matchIndex){
  return `r${roundNum}_m${matchIndex}`;
}

function teamName(id){ return teams[id]?.name ?? `Team ${id}`; }

function teamChipHTML(teamId){
  if (teamId == null) return `<span class="badge">Bye</span>`;
  const t = teams[teamId];
  const players = t.players.map((p,i)=>(
    `<div class="p"><span class="rank">#${i+1}</span><span class="name">${escapeHtml_(p)}</span></div>`
  )).join("");
  return `
    <span class="team-chip" data-team-chip="${teamId}">
      ${escapeHtml_(t.name)}
      <span class="team-pop" role="dialog" aria-label="${escapeHtml_(t.name)} players">
        <div class="hdr">
          <b>${escapeHtml_(t.name)}</b>
          <button class="closex" type="button" data-close-pop="1">Close</button>
        </div>
        ${players}
      </span>
    </span>
  `;
}

/* =========================
   LADDER + PLAYER STATS
   ========================= */

function buildLadder(){
  const base = {};
  Object.keys(teams).forEach(id=>{
    base[id] = {
      teamId:Number(id),
      played:0,
      points:0,
      setsWon:0,
      setsLost:0,
      nightsWon:0,
      nightsLost:0,
      nightsTied:0,
    };
  });

  for (const [k, m] of Object.entries(RESULTS)){
    if (!m || m.a == null || m.b == null) continue;
    const A = base[m.a], B = base[m.b];
    if (!A || !B) continue;

    A.played++; B.played++;
    A.points += Number(m.aPts)||0;
    B.points += Number(m.bPts)||0;

    A.setsWon += Number(m.aSets)||0;
    A.setsLost += Number(m.bSets)||0;
    B.setsWon += Number(m.bSets)||0;
    B.setsLost += Number(m.aSets)||0;

    if (m.aSets > m.bSets){ A.nightsWon++; B.nightsLost++; }
    else if (m.bSets > m.aSets){ B.nightsWon++; A.nightsLost++; }
    else { A.nightsTied++; B.nightsTied++; }
  }

  const rows = Object.values(base);
  rows.sort((x,y)=>{
    const p = y.points - x.points; if (p) return p;
    const sd = (y.setsWon - y.setsLost) - (x.setsWon - x.setsLost); if (sd) return sd;
    const sw = y.setsWon - x.setsWon; if (sw) return sw;
    return x.teamId - y.teamId;
  });
  return rows;
}

function buildPlayerStats(){
  const stats = new Map(); // name -> {name, teamId, setsWon, setsPlayed}
  // init
  for (const [tid, t] of Object.entries(teams)){
    t.players.forEach(p=>{
      stats.set(p, { name:p, teamId:Number(tid), setsWon:0, setsPlayed:0 });
    });
  }

  for (const m of Object.values(RESULTS)){
    if (!m || m.a == null || m.b == null) continue;
    if (!m.pairs) continue;

    const teamA = teams[m.a], teamB = teams[m.b];
    for (const pr of pairings){
      const res = m.pairs[pr.key];
      if (!res) continue;
      const aGames = res.a, bGames = res.b;
      const w = decideSetWinner(aGames, bGames).winner;
      if (!w) continue;

      const aPlayers = pr.a.map(n=>teamA.players[n-1]);
      const bPlayers = pr.b.map(n=>teamB.players[n-1]);

      for (const p of aPlayers){
        const s = stats.get(p); s.setsPlayed++;
        if (w === "A") s.setsWon++;
      }
      for (const p of bPlayers){
        const s = stats.get(p); s.setsPlayed++;
        if (w === "B") s.setsWon++;
      }
    }
  }

  const rows = Array.from(stats.values()).map(s=>{
    const winPct = s.setsPlayed ? (s.setsWon / s.setsPlayed) : 0;
    return {...s, winPct};
  });

  rows.sort((a,b)=>{
    // sort by Win% but require minimum 6 sets to really rank; those below 6 go below if same-ish
    const aQ = a.setsPlayed >= 6, bQ = b.setsPlayed >= 6;
    if (aQ !== bQ) return (bQ ? 1 : -1);
    const wp = b.winPct - a.winPct; if (wp) return wp;
    const sw = b.setsWon - a.setsWon; if (sw) return sw;
    const sp = b.setsPlayed - a.setsPlayed; if (sp) return sp;
    return a.name.localeCompare(b.name);
  });

  return rows;
}

/* =========================
   UI HELPERS
   ========================= */

const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

function escapeHtml_(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function openConfirm(title, msg, onYes){
  const d = $("#confirmDialog");
  $("#confirmTitle").textContent = title;
  $("#confirmMsg").textContent = msg;
  d._onYes = onYes;
  d.showModal();
}
$("#btnConfirmClose").addEventListener("click", ()=>$("#confirmDialog").close());
$("#btnConfirmNo").addEventListener("click", ()=>$("#confirmDialog").close());
$("#btnConfirmYes").addEventListener("click", ()=>{
  const d = $("#confirmDialog");
  const fn = d._onYes;
  d.close();
  if (typeof fn === "function") fn();
});

/* =========================
   RENDER: TEAMS
   ========================= */

function renderTeams(){
  const ids = Object.keys(teams).map(Number).sort((a,b)=>a-b);
  $("#teamsGrid").innerHTML = `
    <div class="grid" style="grid-template-columns:repeat(2,1fr); gap:14px">
      ${ids.map(id=>{
        const t = teams[id];
        return `
          <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none; border-radius:14px">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-start">
                <div>
                  <div class="badge">Team ${id}</div>
                  <h3 class="title" style="margin:8px 0 0">${escapeHtml_(t.name)}</h3>
                </div>
              </div>
              <div style="margin-top:10px">
                ${t.players.map((p,i)=>`
                  <div class="row" style="justify-content:space-between">
                    <span class="muted">Player ${i+1}</span><span>${escapeHtml_(p)}</span>
                  </div>`).join("")}
              </div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* =========================
   RENDER: FIXTURES
   ========================= */

function renderFixtures(){
  const host = $("#fixturesList");
  host.innerHTML = "";

  for (const round of rounds){
    const rows = round.matches.map((m, idx)=>{
      const [a,b] = m;
      const id = matchId(round.r, idx);
      const res = RESULTS[id];
      const badge = !b ? `<span class="badge">Bye</span>` :
        (res ? `<span class="badge good">Recorded</span>` : `<span class="badge">Not played</span>`);
      const summary = (!b) ? "—" : (res ? `${res.aSets}–${res.bSets} (pts ${res.aPts}–${res.bPts})` : "—");
      return `
        <tr>
          <td>${teamChipHTML(a)}</td>
          <td class="center">${b ? "vs" : "—"}</td>
          <td>${b ? teamChipHTML(b) : `<span class="muted">Bye</span>`}</td>
          <td class="right">${badge} <span class="muted" style="margin-left:8px">${summary}</span></td>
        </tr>
      `;
    }).join("");

    host.insertAdjacentHTML("beforeend", `
      <div class="card" id="round-${round.r}" style="background:rgba(255,255,255,.02); box-shadow:none; border-radius:14px; margin-bottom:14px">
        <div class="bd">
          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div>
              <div class="badge">Round ${round.r}</div>
              <div class="muted" style="margin-top:6px">${round.date}</div>
            </div>
            <button class="btn" data-open-round="${round.r}">Upload scores</button>
          </div>
          <table>
            <thead><tr><th>Team A</th><th class="center"></th><th>Team B</th><th class="right">Result</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `);
  }

  $$("[data-open-round]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const r = Number(btn.getAttribute("data-open-round"));
      setView("results");
      $("#roundSelect").value = String(r);
      populateMatchSelect();
      $("#btnLoadSheet").click();
    });
  });

  attachTeamChipHandlers_();
}

/* =========================
   RENDER: LADDER
   ========================= */

function renderLadder(){
  const ladder = buildLadder();
  $("#ladderTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th class="right">#</th>
          <th>Team</th>
          <th class="right">P</th>
          <th class="right">Pts</th>
          <th class="right">Sets W</th>
          <th class="right">Sets L</th>
          <th class="right">Set Diff</th>
          <th class="right">Nights W</th>
          <th class="right">Nights L</th>
          <th class="right">Tied</th>
        </tr>
      </thead>
      <tbody>
        ${ladder.map((row, i)=>{
          const diff = row.setsWon - row.setsLost;
          return `
            <tr>
              <td class="right">${i+1}</td>
              <td>${teamChipHTML(row.teamId)}</td>
              <td class="right">${row.played}</td>
              <td class="right"><b>${row.points}</b></td>
              <td class="right">${row.setsWon}</td>
              <td class="right">${row.setsLost}</td>
              <td class="right">${diff}</td>
              <td class="right">${row.nightsWon}</td>
              <td class="right">${row.nightsLost}</td>
              <td class="right">${row.nightsTied}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;

  attachTeamChipHandlers_();

  // KPIs
  const matchCount = Object.values(RESULTS).filter(m=>m && m.a!=null && m.b!=null).length;
  const roundsDone = new Set(Object.keys(RESULTS).map(k=>k.split("_")[0])).size;
  $("#kpiRoundsDone").textContent = String(roundsDone);
  $("#kpiMatchesDone").textContent = String(matchCount);
  const leader = ladder[0]?.teamId;
  $("#kpiTopTeam").textContent = leader ? `Team ${leader}` : "—";

  const players = buildPlayerStats();
  $("#kpiTopPlayer").textContent = players[0]?.name ?? "—";
}

/* =========================
   RENDER: PLAYER STATS
   ========================= */

function renderPlayerStats(){
  const rows = buildPlayerStats();
  $("#playerStatsTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Team</th>
          <th class="right">Sets Won</th>
          <th class="right">Sets Played</th>
          <th class="right">Win %</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const pct = r.setsPlayed ? (r.winPct*100).toFixed(1) : "0.0";
          const badge = r.setsPlayed < 6 ? `<span class="badge warn" title="Small sample size">&lt;6 sets</span>` : "";
          return `
            <tr>
              <td>${escapeHtml_(r.name)} ${badge}</td>
              <td>${teamChipHTML(r.teamId)}</td>
              <td class="right"><b>${r.setsWon}</b></td>
              <td class="right">${r.setsPlayed}</td>
              <td class="right">${pct}%</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
  attachTeamChipHandlers_();
}

/* =========================
   HOME
   ========================= */

function getNextRound(){
  for (const round of rounds){
    let allDone = true;
    for (let i=0;i<round.matches.length;i++){
      const [a,b] = round.matches[i];
      if (b == null) continue;
      const id = matchId(round.r, i);
      if (!RESULTS[id]) { allDone = false; break; }
    }
    if (!allDone) return round;
  }
  return null;
}

function renderHome(){
  const next = getNextRound();
  if (!next){
    $("#nextRoundPill").textContent = "Season complete";
    $("#nextRoundDate").textContent = "";
    $("#nextRoundMatches").innerHTML = `<div class="muted">All rounds have results.</div>`;
  } else {
    $("#nextRoundPill").textContent = `Round ${next.r}`;
    $("#nextRoundDate").textContent = next.date;

    const list = next.matches.map((m,idx)=>{
      const [a,b] = m;
      if (b == null) return `
        <div class="row" style="justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)">
          <div>${teamChipHTML(a)}</div><div class="muted">Bye</div>
        </div>`;
      const id = matchId(next.r, idx);
      const res = RESULTS[id];
      const summary = res ? `${res.aSets}–${res.bSets} (pts ${res.aPts}–${res.bPts})` : "Not played";
      return `
        <div class="row" style="justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)">
          <div>${teamChipHTML(a)} <span class="muted">vs</span> ${teamChipHTML(b)}</div>
          <div class="muted">${summary}</div>
        </div>`;
    }).join("");
    $("#nextRoundMatches").innerHTML = `<div>${list}</div>`;
  }

  // Latest results
  const latest = Object.entries(RESULTS)
    .map(([k,v])=>({k,v}))
    .filter(x=>x.v && x.v.a!=null && x.v.b!=null)
    .sort((x,y)=>(y.v.ts||0)-(x.v.ts||0))
    .slice(0,6);

  if (!latest.length){
    $("#latestResults").innerHTML = `<div class="muted">No results uploaded yet.</div>`;
  } else {
    $("#latestResults").innerHTML = `
      <table>
        <thead><tr><th>Round</th><th>Match</th><th class="right">Sets</th><th class="right">Points</th><th class="right">Total Games</th></tr></thead>
        <tbody>
          ${latest.map(x=>{
            const [rPart, mPart] = x.k.split("_");
            const r = Number(rPart.replace("r",""));
            const date = rounds.find(rr=>rr.r===r)?.date ?? "";
            const m = x.v;
            return `
              <tr>
                <td>R${r} <span class="muted">${date}</span></td>
                <td>${teamChipHTML(m.a)} <span class="muted">vs</span> ${teamChipHTML(m.b)}</td>
                <td class="right"><b>${m.aSets}–${m.bSets}</b></td>
                <td class="right"><span class="muted">${m.aPts}–${m.bPts}</span></td>
                <td class="right"><span class="muted">${m.aGamesTotal}–${m.bGamesTotal}</span></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
    attachTeamChipHandlers_();
  }
}

/* =========================
   UPLOAD SCORES (sheet UI)
   ========================= */

function populateRoundSelect(){
  const rs = $("#roundSelect");
  const rj = $("#roundJump");
  rs.innerHTML = "";
  rj.innerHTML = "";
  rounds.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = String(r.r);
    opt.textContent = `Round ${r.r} — ${r.date}`;
    rs.appendChild(opt);

    const opt2 = document.createElement("option");
    opt2.value = String(r.r);
    opt2.textContent = `Round ${r.r}`;
    rj.appendChild(opt2);
  });
}

function populateMatchSelect(){
  const r = Number($("#roundSelect").value);
  const round = rounds.find(x=>x.r===r);
  const ms = $("#matchSelect");
  ms.innerHTML = "";
  round.matches.forEach((m,idx)=>{
    const [a,b] = m;
    if (b == null) return; // omit byes from upload
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = `${teamName(a)} vs ${teamName(b)}`;
    ms.appendChild(opt);
  });
  // if all are byes (won't happen), handle
  $("#btnLoadSheet").disabled = ms.options.length === 0;
}

function getSelectedMatch_(){
  const r = Number($("#roundSelect").value);
  const idx = Number($("#matchSelect").value);
  const round = rounds.find(x=>x.r===r);
  const [a,b] = round.matches[idx];
  return { round, r, idx, a, b, id: matchId(r, idx) };
}

function renderScoreSheet(){
  const host = $("#sheetHost");
  host.innerHTML = "";

  const ms = $("#matchSelect");
  if (!ms.options.length){
    host.innerHTML = `<div class="muted">No match selected.</div>`;
    return;
  }

  const {round, r, idx, a, b, id} = getSelectedMatch_();
  const existing = RESULTS[id];

  const teamA = teams[a], teamB = teams[b];

  // build initial values
  const pairsObj = existing?.pairs || {};
  const rows = pairings.map(pr=>{
    const val = pairsObj[pr.key] || {a:"", b:""};
    return { ...pr, aVal: val.a, bVal: val.b };
  });

  host.innerHTML = `
    <div class="sheet" data-match-id="${id}">
      <div class="head">
        <div class="meta">
          <div class="line"><b>Berwick Tennis Club</b> • Men's Night Comp • <b>Autumn 2026</b></div>
          <div class="line">Date: <b>${round.date}</b> • Round: <b>${r}</b></div>
          <div class="line">${teamName(a)} vs ${teamName(b)}</div>
        </div>
        <div class="row">
          <span class="badge">Enter games (first to 6)</span>
          <button class="btn primary" id="btnSaveSheet">Save</button>
        </div>

        <div class="teams">
          <div class="teamBox">
            <div class="tname">${teamName(a)}</div>
            <div class="plist">
              ${teamA.players.map((p,i)=>`
                <div class="prow"><span class="r">#${i+1}</span><span>${escapeHtml_(p)}</span></div>
              `).join("")}
            </div>
          </div>
          <div class="teamBox">
            <div class="tname">${teamName(b)}</div>
            <div class="plist">
              ${teamB.players.map((p,i)=>`
                <div class="prow"><span class="r">#${i+1}</span><span>${escapeHtml_(p)}</span></div>
              `).join("")}
            </div>
          </div>
        </div>
      </div>

      <div>
        ${rows.map(pr=>{
          const aNames = pr.a.map(n=>teamA.players[n-1]).join(" & ");
          const bNames = pr.b.map(n=>teamB.players[n-1]).join(" & ");
          return `
            <div class="gridRow" data-pair="${pr.key}">
              <div class="pairTag">${pr.label}</div>

              <div class="cell">
                <span class="who">${escapeHtml_(aNames)}</span>
                <input type="number" min="0" max="10" step="1" inputmode="numeric" data-side="a" value="${pr.aVal ?? ""}" placeholder="Games" aria-label="${teamName(a)} games for ${pr.label}"/>
              </div>

              <div class="cell">
                <span class="who">${escapeHtml_(bNames)}</span>
                <input type="number" min="0" max="10" step="1" inputmode="numeric" data-side="b" value="${pr.bVal ?? ""}" placeholder="Games" aria-label="${teamName(b)} games for ${pr.label}"/>
              </div>

              <div class="cell rightish" style="justify-content:flex-end">
                <span class="winMark" data-win="${pr.key}">—</span>
              </div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="bd">
        <div id="sheetWarnings"></div>
        <div class="totals">
          <div class="tot">
            <div class="k">Sets</div>
            <div class="v"><span id="aSetsOut">0</span> – <span id="bSetsOut">0</span></div>
            <div class="muted" style="margin-top:6px">${teamName(a)} vs ${teamName(b)}</div>
          </div>
          <div class="tot">
            <div class="k">Points (incl. bonus)</div>
            <div class="v"><span id="aPtsOut">0</span> – <span id="bPtsOut">0</span></div>
            <div class="muted" style="margin-top:6px">+2 bonus for winning the night</div>
          </div>
          <div class="tot">
            <div class="k">Total Games</div>
            <div class="v"><span id="aGamesOut">0</span> – <span id="bGamesOut">0</span></div>
            <div class="muted" style="margin-top:6px">Sum across 6 sets</div>
          </div>
        </div>

        <div class="foot">When saved, this match updates Fixtures, Ladder, and Player Stats.</div>
      </div>
    </div>
  `;

  // attach input listeners for live calc
  const sheet = host.querySelector(".sheet");
  sheet.querySelectorAll("input[type='number']").forEach(inp=>{
    inp.addEventListener("input", ()=>recalcSheet_(sheet, a, b));
    inp.addEventListener("keydown", (e)=>{
      // Enter jumps to next input for fast mobile entry
      if (e.key === "Enter"){
        e.preventDefault();
        const inputs = Array.from(sheet.querySelectorAll("input[type='number']"));
        const i = inputs.indexOf(inp);
        const next = inputs[i+1] || inputs[0];
        next.focus();
        next.select?.();
      }
    });
  });

  sheet.querySelector("#btnSaveSheet").addEventListener("click", ()=>{
    const computed = recalcSheet_(sheet, a, b, true);
    if (!computed.ok){
      // still allow save; confirm if lots of warnings
      openConfirm("Save with warnings?", "Some sets don’t look like a standard 6–x score. Save anyway?", ()=>{
        saveSheet_(sheet, a, b, computed);
      });
      return;
    }
    saveSheet_(sheet, a, b, computed);
  });

  recalcSheet_(sheet, a, b);
}

function recalcSheet_(sheetEl, aTeamId, bTeamId, returnObject=false){
  const warnings = [];
  const pairsOut = {};
  let aSets = 0, bSets = 0;
  let aGamesTotal = 0, bGamesTotal = 0;
  let ok = true;

  for (const pr of pairings){
    const row = sheetEl.querySelector(`[data-pair="${pr.key}"]`);
    const aInp = row.querySelector(`input[data-side="a"]`);
    const bInp = row.querySelector(`input[data-side="b"]`);
    const aVal = aInp.value === "" ? null : Number(aInp.value);
    const bVal = bInp.value === "" ? null : Number(bInp.value);

    if (aVal != null) aGamesTotal += aVal;
    if (bVal != null) bGamesTotal += bVal;

    pairsOut[pr.key] = { a: (aVal==null?"":aVal), b: (bVal==null?"":bVal) };

    const winBadge = row.querySelector(`[data-win="${pr.key}"]`);
    const d = decideSetWinner(aVal, bVal);

    if (d.status === "empty"){
      winBadge.textContent = "—";
      winBadge.className = "winMark";
      continue;
    }

    if (d.winner === "A"){
      aSets++;
      winBadge.textContent = `${teamName(aTeamId)} win`;
      winBadge.className = "winMark good";
      if (d.status === "warn"){ ok = false; warnings.push(`${pr.label}: unusual score (${aVal}–${bVal})`); winBadge.className = "winMark warn"; }
    } else if (d.winner === "B"){
      bSets++;
      winBadge.textContent = `${teamName(bTeamId)} win`;
      winBadge.className = "winMark good";
      if (d.status === "warn"){ ok = false; warnings.push(`${pr.label}: unusual score (${aVal}–${bVal})`); winBadge.className = "winMark warn"; }
    } else {
      ok = false;
      winBadge.textContent = "Check";
      winBadge.className = "winMark bad";
      warnings.push(`${pr.label}: no clear winner (${aVal}–${bVal})`);
    }
  }

  const pts = calcNightPoints(aSets, bSets);

  sheetEl.querySelector("#aSetsOut").textContent = String(aSets);
  sheetEl.querySelector("#bSetsOut").textContent = String(bSets);
  sheetEl.querySelector("#aPtsOut").textContent = String(pts.aPts);
  sheetEl.querySelector("#bPtsOut").textContent = String(pts.bPts);
  sheetEl.querySelector("#aGamesOut").textContent = String(aGamesTotal);
  sheetEl.querySelector("#bGamesOut").textContent = String(bGamesTotal);

  const warnHost = sheetEl.querySelector("#sheetWarnings");
  if (!warnings.length){
    warnHost.innerHTML = `<span class="badge good">All good</span>`;
  } else {
    warnHost.innerHTML = `
      <div class="row" style="margin-bottom:8px">
        <span class="badge warn">Warnings</span>
        <span class="muted">You can still save, but double-check these lines.</span>
      </div>
      <ul style="margin:0; padding-left:18px; color: var(--muted); line-height:1.5">
        ${warnings.map(w=>`<li>${escapeHtml_(w)}</li>`).join("")}
      </ul>
    `;
  }

  const out = {
    ok,
    pairs: pairsOut,
    aSets, bSets,
    aGamesTotal, bGamesTotal,
    aPts: pts.aPts, bPts: pts.bPts
  };
  return returnObject ? out : out;
}

function saveSheet_(sheetEl, aTeamId, bTeamId, computed){
  const id = sheetEl.getAttribute("data-match-id");
  RESULTS[id] = {
    a: aTeamId,
    b: bTeamId,
    pairs: Object.fromEntries(Object.entries(computed.pairs).map(([k,v])=>[k,{a: (v.a===""?null:Number(v.a)), b:(v.b===""?null:Number(v.b))}])),
    aSets: computed.aSets,
    bSets: computed.bSets,
    aGamesTotal: computed.aGamesTotal,
    bGamesTotal: computed.bGamesTotal,
    aPts: computed.aPts,
    bPts: computed.bPts,
    ts: Date.now()
  };
  saveResults_();
  toast_("Saved ✔");
  // refresh dependent pages
  renderHome();
  renderFixtures();
  renderLadder();
  renderPlayerStats();
}

function clearSelectedMatch(){
  const ms = $("#matchSelect");
  if (!ms.options.length) return;
  const {id} = getSelectedMatch_();
  if (!RESULTS[id]) { toast_("Nothing to clear"); return; }
  openConfirm("Clear this match?", "This will remove this match result from your device.", ()=>{
    delete RESULTS[id];
    saveResults_();
    $("#sheetHost").innerHTML = `<div class="muted">Match cleared. Load the score sheet to re-enter.</div>`;
    renderHome(); renderFixtures(); renderLadder(); renderPlayerStats();
    toast_("Cleared");
  });
}

function resetAllResults(){
  openConfirm("Reset ALL results?", "This will delete all saved results on this device.", ()=>{
    RESULTS = {};
    saveResults_();
    $("#sheetHost").innerHTML = `<div class="muted">All results cleared.</div>`;
    renderHome(); renderFixtures(); renderLadder(); renderPlayerStats();
    toast_("Reset");
  });
}

/* =========================
   TEAM CHIP (tap handling)
   ========================= */

function attachTeamChipHandlers_(){
  // close on outside click (mobile)
  document.addEventListener("click", (e)=>{
    const chip = e.target.closest?.(".team-chip");
    if (!chip){
      $$(".team-chip[data-open='true']").forEach(c=>c.removeAttribute("data-open"));
      return;
    }
  }, {capture:true});

  $$(".team-chip").forEach(chip=>{
    chip.addEventListener("click", (e)=>{
      // if click close button
      const closeBtn = e.target.closest?.("[data-close-pop]");
      if (closeBtn){
        chip.removeAttribute("data-open");
        e.stopPropagation();
        return;
      }
      // toggle only on small screens (tap)
      if (window.matchMedia("(max-width: 760px)").matches){
        const open = chip.getAttribute("data-open") === "true";
        $$(".team-chip[data-open='true']").forEach(c=>c.removeAttribute("data-open"));
        if (!open) chip.setAttribute("data-open","true");
        e.stopPropagation();
      }
    });
  });
}

/* =========================
   NAV
   ========================= */

function setView(name){
  $$(".tab").forEach(t=>t.setAttribute("aria-selected", String(t.dataset.view===name)));
  $$(".view").forEach(v=>v.hidden = true);
  $(`#view-${name}`).hidden = false;

  if (name==="home"){ renderHome(); renderLadder(); }
  if (name==="teams"){ renderTeams(); attachTeamChipHandlers_(); }
  if (name==="fixtures"){ renderFixtures(); }
  if (name==="results"){ /* no auto render */ }
  if (name==="ladder"){ renderLadder(); }
  if (name==="players"){ renderPlayerStats(); }
}

/* =========================
   EXPORT / IMPORT / PRINT
   ========================= */

function exportResults(){
  const blob = new Blob([JSON.stringify(RESULTS, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "btc_thursday_autumn_2026_results.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function importResults(file){
  const txt = await file.text();
  const obj = JSON.parse(txt);
  if (!obj || typeof obj !== "object") throw new Error("Invalid file");
  RESULTS = obj;
  saveResults_();
  renderHome(); renderFixtures(); renderLadder(); renderPlayerStats();
  toast_("Imported ✔");
}

/* =========================
   TOAST
   ========================= */
let toastTimer = null;
function toast_(msg){
  let el = document.getElementById("toast");
  if (!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "22px";
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(18,26,51,.95)";
    el.style.border = "1px solid rgba(255,255,255,.15)";
    el.style.color = "white";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "999px";
    el.style.boxShadow = "0 10px 30px rgba(0,0,0,.35)";
    el.style.zIndex = "999";
    el.style.fontSize = "13px";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1800);
}

/* =========================
   INIT
   ========================= */

function init(){
  // Tabs
  $$(".tab").forEach(btn=>btn.addEventListener("click", ()=>setView(btn.dataset.view)));

  // Round select + match select
  populateRoundSelect();
  $("#roundSelect").addEventListener("change", ()=>{
    populateMatchSelect();
    $("#sheetHost").innerHTML = "";
  });

  $("#btnLoadSheet").addEventListener("click", ()=>{
    renderScoreSheet();
  });

  $("#btnClearMatch").addEventListener("click", clearSelectedMatch);
  $("#btnResetAll").addEventListener("click", resetAllResults);

  // fixtures jump
  $("#btnGo").addEventListener("click", ()=>{
    const r = Number($("#roundJump").value);
    const el = document.getElementById(`round-${r}`);
    if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
  });

  // Print/export/import
  $("#btnPrint").addEventListener("click", ()=>window.print());
  $("#btnExport").addEventListener("click", exportResults);
  $("#importFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    try{ await importResults(f); }
    catch(err){ alert(err?.message || "Import failed"); }
    finally{ e.target.value = ""; }
  });

  // default selects
  $("#roundSelect").value = "1";
  populateMatchSelect();

  // initial render
  setView("home");
  renderTeams(); // pre-render once for fast switch
  renderPlayerStats();
  renderFixtures();
  renderLadder();
}

init();
</script>
</body>
</html>
